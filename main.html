<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trust the Process</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let isAuthReady = false;
        let gameData = null;

        const mainContainer = document.getElementById('main-container');
        const loginSection = document.getElementById('login-section');
        const gameSection = document.getElementById('game-section');
        const currentProcessEl = document.getElementById('current-process');
        const judgeStatusEl = document.getElementById('judge-status');
        const stepInput = document.getElementById('step-input');
        const submitStepBtn = document.getElementById('submit-step-btn');
        const submittedStepsContainer = document.getElementById('submitted-steps-container');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const playerListEl = document.getElementById('player-list');
        const playerUserIdEl = document.getElementById('player-user-id');
        const gameStatusMessageEl = document.getElementById('game-status-message');

        const GAME_PATH = `artifacts/${appId}/public/data/trust_the_process`;
        const PLAYERS_PATH = `artifacts/${appId}/public/data/players`;
        const GAME_DOC = 'game_state';

        // Custom modal for displaying messages
        function showMessage(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Firebase authentication listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                playerUserIdEl.textContent = `Your User ID: ${currentUserId}`;
                isAuthReady = true;
                listenToGameState();
                await joinGame();
            } else {
                await setPersistence(auth, browserLocalPersistence);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        async function joinGame() {
            if (!isAuthReady) return;
            const playerDocRef = doc(db, PLAYERS_PATH, currentUserId);
            const playerData = {
                userId: currentUserId,
                lastActive: Date.now()
            };
            await setDoc(playerDocRef, playerData, { merge: true });
            console.log("Joined the game as:", currentUserId);
        }

        async function getOnlinePlayers() {
            const playersQuery = query(collection(db, PLAYERS_PATH));
            const playerDocs = await getDocs(playersQuery);
            const players = playerDocs.docs.map(doc => doc.data().userId);
            return players;
        }

        // --- Game Logic Functions ---

        async function startGame() {
            if (!isAuthReady) return;
            try {
                const players = await getOnlinePlayers();
                if (players.length < 2) {
                    showMessage("You need at least two players to start the game.");
                    return;
                }
                const gameDocRef = doc(db, GAME_PATH, GAME_DOC);
                const initialProcess = "Making toast"; // Default starting process
                const initialJudge = players[Math.floor(Math.random() * players.length)];
                await setDoc(gameDocRef, {
                    hostId: currentUserId,
                    judgeId: initialJudge,
                    currentProcess: initialProcess,
                    submittedSteps: {},
                    roundNumber: 1,
                    gameState: 'WAITING_FOR_SUBMISSIONS',
                    players: players,
                });
                showMessage("Game started! The new process is: " + initialProcess);
            } catch (e) {
                console.error("Error starting game: ", e);
                showMessage("An error occurred while starting the game.");
            }
        }

        async function submitStep() {
            if (!isAuthReady) return;
            const step = stepInput.value.trim();
            if (!step) {
                showMessage("Please enter a step before submitting.");
                return;
            }
            try {
                const gameDocRef = doc(db, GAME_PATH, GAME_DOC);
                const submittedSteps = gameData.submittedSteps;
                submittedSteps[currentUserId] = step;

                // Check if all players (except the judge) have submitted
                const nonJudgePlayers = gameData.players.filter(p => p !== gameData.judgeId);
                const submittedPlayerIds = Object.keys(submittedSteps).filter(id => id !== gameData.judgeId);
                const allSubmitted = nonJudgePlayers.every(id => submittedPlayerIds.includes(id));
                const newGameState = allSubmitted ? 'JUDGING_PHASE' : 'WAITING_FOR_SUBMISSIONS';

                await updateDoc(gameDocRef, {
                    submittedSteps: submittedSteps,
                    gameState: newGameState,
                });

                stepInput.value = '';
            } catch (e) {
                console.error("Error submitting step: ", e);
                showMessage("An error occurred while submitting your step.");
            }
        }

        async function selectWinner(winningUserId) {
            if (!isAuthReady) return;
            try {
                const gameDocRef = doc(db, GAME_PATH, GAME_DOC);
                const winningStep = gameData.submittedSteps[winningUserId];
                const nextJudgeIndex = (gameData.players.indexOf(gameData.judgeId) + 1) % gameData.players.length;
                const nextJudgeId = gameData.players[nextJudgeIndex];

                await updateDoc(gameDocRef, {
                    judgeId: nextJudgeId,
                    currentProcess: winningStep,
                    submittedSteps: {}, // Clear for next round
                    roundNumber: gameData.roundNumber + 1,
                    gameState: 'WAITING_FOR_SUBMISSIONS',
                });
                showMessage("Winning step selected! Starting the next round.");
            } catch (e) {
                console.error("Error selecting winner: ", e);
                showMessage("An error occurred while selecting the winner.");
            }
        }

        // --- UI Rendering and Firestore Listener ---

        function renderGame() {
            if (!gameData) {
                gameStatusMessageEl.textContent = "Waiting for game to start...";
                submittedStepsContainer.innerHTML = '';
                return;
            }

            // Check if this user is the host to show the start button
            startGameBtn.classList.add('hidden');
            if (gameData.hostId === currentUserId && gameData.gameState === 'LOBBY') {
                startGameBtn.classList.remove('hidden');
                gameStatusMessageEl.textContent = "You are the host. Click 'Start Game' to begin.";
            } else if (gameData.gameState === 'LOBBY') {
                gameStatusMessageEl.textContent = "Waiting for the host to start the game...";
            }

            // Player list
            playerListEl.innerHTML = '';
            gameData.players.forEach(pId => {
                const playerEl = document.createElement('div');
                playerEl.textContent = pId;
                playerEl.classList.add('p-2', 'rounded-md', 'bg-gray-100', 'text-sm', 'font-mono', 'text-center', 'truncate', 'shadow-sm', 'border');
                if (pId === gameData.judgeId) {
                    playerEl.classList.add('border-blue-500', 'bg-blue-100', 'font-bold');
                }
                playerListEl.appendChild(playerEl);
            });

            // Update UI based on game state
            currentProcessEl.textContent = gameData.currentProcess;

            const isJudge = gameData.judgeId === currentUserId;
            judgeStatusEl.textContent = isJudge ? "You are the Judge." : `The Judge is: ${gameData.judgeId}`;
            judgeStatusEl.classList.toggle('text-blue-600', isJudge);
            judgeStatusEl.classList.toggle('text-gray-500', !isJudge);

            const submittedCount = Object.keys(gameData.submittedSteps).length;
            const nonJudgePlayersCount = gameData.players.length - 1;
            gameStatusMessageEl.textContent = `Round ${gameData.roundNumber} | Submitted steps: ${submittedCount}/${nonJudgePlayersCount}`;

            // Show or hide elements based on game state
            submitStepBtn.classList.toggle('hidden', isJudge || gameData.gameState !== 'WAITING_FOR_SUBMISSIONS');
            stepInput.classList.toggle('hidden', isJudge || gameData.gameState !== 'WAITING_FOR_SUBMISSIONS');
            
            submittedStepsContainer.innerHTML = ''; // Clear old steps
            if (gameData.gameState === 'JUDGING_PHASE' || isJudge) {
                // Shuffle the steps to present them anonymously to the judge
                const shuffledSteps = Object.keys(gameData.submittedSteps)
                    .map(key => ({ userId: key, step: gameData.submittedSteps[key] }))
                    .sort(() => Math.random() - 0.5);

                shuffledSteps.forEach(stepObj => {
                    const stepCard = document.createElement('div');
                    stepCard.classList.add('bg-white', 'p-4', 'rounded-xl', 'shadow-md', 'border', 'border-gray-200', 'hover:border-blue-400', 'cursor-pointer', 'transition', 'text-gray-800', 'text-lg', 'text-center');
                    stepCard.textContent = stepObj.step;
                    
                    if (isJudge) {
                        // Judge can click to select the winner
                        stepCard.onclick = () => selectWinner(stepObj.userId);
                    } else {
                         stepCard.classList.add('cursor-not-allowed');
                    }
                    
                    submittedStepsContainer.appendChild(stepCard);
                });
            } else {
                gameStatusMessageEl.textContent = "Waiting for all players to submit their steps...";
            }
        }

        // Main Firestore Listener
        function listenToGameState() {
            if (!isAuthReady) {
                console.warn("Auth not ready, cannot listen to game state.");
                return;
            }
            const gameDocRef = doc(db, GAME_PATH, GAME_DOC);
            onSnapshot(gameDocRef, (doc) => {
                if (doc.exists()) {
                    gameData = doc.data();
                    if (!gameData.players.includes(currentUserId)) {
                        // User joined after game started, redirect to a waiting state
                        showMessage("A game is already in progress. Please wait for the next game to start or refresh to join.");
                        // Optional: Reset game state on Firestore if all players leave
                        return;
                    }
                    renderGame();
                } else {
                    // Game document doesn't exist, show "Start Game" button
                    gameData = {
                        gameState: 'LOBBY',
                        hostId: null,
                        players: [],
                    };
                    renderGame();
                }
            }, (error) => {
                console.error("Error listening to game state: ", error);
                showMessage("Connection error. Please check your internet and refresh the page.");
            });
        }
    </script>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div id="main-container" class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-4xl mx-auto flex flex-col md:flex-row gap-6">
        
        <!-- Game Column -->
        <div id="game-section" class="w-full md:w-2/3 flex flex-col gap-6">
            <h1 class="text-4xl font-extrabold text-blue-600 tracking-tight text-center">Trust the Process</h1>

            <!-- Game Status -->
            <div class="bg-gray-100 p-4 rounded-xl text-center shadow-inner">
                <p id="game-status-message" class="font-bold text-gray-700">Loading...</p>
                <p id="judge-status" class="mt-1 text-sm font-medium text-gray-500"></p>
            </div>
            
            <!-- Current Process Card -->
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-2xl shadow-lg transform transition-transform hover:scale-105">
                <h2 class="text-xl font-semibold mb-2">The Process:</h2>
                <p id="current-process" class="text-3xl font-bold leading-tight">Waiting for game to start...</p>
            </div>
            
            <!-- Step Submission Input -->
            <div class="flex gap-4 items-end">
                <input id="step-input" type="text" placeholder="Type your step here..." class="flex-1 p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm">
                <button id="submit-step-btn" onclick="submitStep()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:bg-blue-700 transition">Submit Step</button>
            </div>

            <!-- Submitted Steps Grid -->
            <div id="submitted-steps-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Step cards will be rendered here -->
            </div>
            
            <button id="start-game-btn" onclick="startGame()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:bg-green-700 transition hidden">Start Game</button>
        </div>

        <!-- Sidebar Column (Players) -->
        <div class="w-full md:w-1/3 flex flex-col gap-4">
            <h2 class="text-2xl font-bold text-gray-800 text-center">Players</h2>
            <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                 <p id="player-user-id" class="text-xs font-mono text-gray-600 mb-2 truncate">Loading User ID...</p>
                <div id="player-list" class="flex flex-col gap-2">
                    <!-- Player IDs will be rendered here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Messages -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="modal-close-btn" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-700 transition">OK</button>
        </div>
    </div>
</body>
</html>